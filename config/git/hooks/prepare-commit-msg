#!/bin/bash
# Append Jira tag if branch is connected to a Jira issue

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
# SHA1=$3

# exit if commit is a fixup
grep -q 'fixup' "$COMMIT_MSG_FILE" && exit 0

# get current branch
branch_name=$(git rev-parse --abbrev-ref HEAD)

# check that branch has jira id and title; i.e. "feature/ABC-123-description"
jira_tag_id=$(echo "$branch_name" | sed -nr 's,[a-z]*/?([A-Z0-9]+-[0-9]+)-.+,\1,p')

if [[ -n "$jira_tag_id" ]]; then
	# exit if jira_tag_id is found already in the commit message
	grep -q "^$jira_tag_id:" "$COMMIT_MSG_FILE" && exit 0

	printf "\nó°Œƒ Prepending Jira issue id to commit message...\n\n"

	# check  if commit was initiated with editor/template
	if [[ "$COMMIT_SOURCE" == "template" ]]; then
		command="0,/^$/{s/^$/$jira_tag_id: /}"
	else
		# ...or with -m flag
		command="1s/^/$jira_tag_id: /"
	fi

	# if command is set, prepend jira issue id to the commit message
	[[ -n $command ]] && sed -i.bak -e "$command" "$COMMIT_MSG_FILE"
fi
